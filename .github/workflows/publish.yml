name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g., v7.10.0)"
        required: true
        type: string

jobs:
  download-assets:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag#v }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ steps.version.outputs.TAG }}
          fileName: "*.jar"
          out-file-path: "release-jars"

      - name: List downloaded files
        run: ls -la release-jars/

      - name: Upload artifacts for other jobs
        uses: actions/upload-artifact@v4
        with:
          name: release-jars
          path: release-jars/
          retention-days: 1

  publish-modrinth:
    needs: download-assets
    runs-on: ubuntu-latest
    steps:
      - name: Download release jars
        uses: actions/download-artifact@v4
        with:
          name: release-jars
          path: release-jars

      - name: Get release body
        id: release
        uses: cardinalby/git-get-release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ vars.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: |
            release-jars/BanManagerFabric-mc1.20.1.jar
            release-jars/BanManagerFabric-mc1.21.1.jar
            release-jars/BanManagerFabric-mc1.21.4.jar
          name: "BanManager v${{ needs.download-assets.outputs.version }}"
          version: ${{ needs.download-assets.outputs.version }}
          version-type: release
          changelog: ${{ steps.release.outputs.body }}
          loaders: fabric
          game-versions: |
            1.20.1
            1.21.1
            1.21.4
          game-version-filter: releases
          dependencies: |
            fabric-api@* (required)

  publish-curseforge:
    needs: download-assets
    runs-on: ubuntu-latest
    steps:
      - name: Download release jars
        uses: actions/download-artifact@v4
        with:
          name: release-jars
          path: release-jars

      - name: Get release body
        id: release
        uses: cardinalby/git-get-release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

      - name: Publish to CurseForge
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          curseforge-id: ${{ vars.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          files: release-jars/BanManagerBukkit.jar
          name: "BanManager v${{ needs.download-assets.outputs.version }}"
          version: ${{ needs.download-assets.outputs.version }}
          version-type: release
          changelog: ${{ steps.release.outputs.body }}
          loaders: |
            bukkit
            spigot
            paper
          game-versions: |
            1.17.1
            1.18.2
            1.19.4
            1.20.1
            1.20.4
            1.20.6
            1.21
            1.21.1
            1.21.4
          game-version-filter: releases

  publish-hangar:
    needs: download-assets
    runs-on: ubuntu-latest
    steps:
      - name: Download release jars
        uses: actions/download-artifact@v4
        with:
          name: release-jars
          path: release-jars

      - name: Get release body
        id: release
        uses: cardinalby/git-get-release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

      - name: Publish to Hangar
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          hangar-id: ${{ vars.HANGAR_PROJECT_ID }}
          hangar-token: ${{ secrets.HANGAR_TOKEN }}
          files: |
            release-jars/BanManagerBukkit.jar
            release-jars/BanManagerVelocity.jar
          name: "BanManager v${{ needs.download-assets.outputs.version }}"
          version: ${{ needs.download-assets.outputs.version }}
          version-type: release
          changelog: ${{ steps.release.outputs.body }}
          loaders: |
            paper
            spigot
            bukkit
            velocity
          game-versions: |
            1.17.1
            1.18.2
            1.19.4
            1.20.1
            1.20.4
            1.20.6
            1.21
            1.21.1
            1.21.4
          game-version-filter: releases

  publish-sponge-ore:
    needs: download-assets
    runs-on: ubuntu-latest
    steps:
      - name: Download release jars
        uses: actions/download-artifact@v4
        with:
          name: release-jars
          path: release-jars

      - name: Publish Sponge API 8+ to Ore
        run: |
          curl -X POST "https://ore.spongepowered.org/api/v2/projects/BanManager/versions" \
            -H "Authorization: OreApi apikey=${{ secrets.ORE_API_KEY }}" \
            -F "plugin-info={\"recommended\": true, \"createForumPost\": false}" \
            -F "plugin-file=@release-jars/BanManagerSponge.jar"

      - name: Publish Sponge API 7 to Ore
        run: |
          curl -X POST "https://ore.spongepowered.org/api/v2/projects/BanManager/versions" \
            -H "Authorization: OreApi apikey=${{ secrets.ORE_API_KEY }}" \
            -F "plugin-info={\"recommended\": false, \"createForumPost\": false}" \
            -F "plugin-file=@release-jars/BanManagerSponge7.jar"
