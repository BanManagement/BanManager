name: Create Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up JDK 17 for Fabric 1.20.x builds (Gradle toolchain will use this)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: "temurin"

      # Set up JDK 21 as the primary JDK
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - uses: actions/cache@v4
        with:
          path: |
            .gradle/loom-cache
          key: ${{ runner.os }}-loom-${{ hashFiles('**/libs.versions.*', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-loom-

      - name: Build with Gradle
        run: ./gradlew build --build-cache

      # Build all Fabric versions
      - name: Build all Fabric versions
        run: ./gradlew :fabric:1.20.1:remapJar :fabric:1.21.1:remapJar :fabric:1.21.4:remapJar --build-cache

      # Build both Sponge modules (legacy API 7 and modern API 11+)
      - name: Build Sponge modules
        run: ./gradlew :BanManagerSponge:shadowJar :BanManagerSponge7:shadowJar --build-cache

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: "v${{ steps.version.outputs.VERSION }}"
          body: |
            ## What's New

            <!-- Write your release notes here using - prefix for each item -->
            <!-- Use **bold** for emphasis, it will render on the website -->

            ---

            [Download Bukkit](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerBukkit.jar)
            [Download BungeeCord](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerBungeeCord.jar)
            [Download Velocity](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerVelocity.jar)
            [Download Sponge](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerSponge.jar)
            [Download Sponge 7](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerSponge7.jar)
            [Download Fabric 1.20.1](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerFabric-mc1.20.1.jar)
            [Download Fabric 1.21.1](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerFabric-mc1.21.1.jar)
            [Download Fabric 1.21.4](https://github.com/BanManagement/BanManager/releases/download/v${{ steps.version.outputs.VERSION }}/BanManagerFabric-mc1.21.4.jar)
          files: |
            bukkit/build/libs/BanManagerBukkit.jar
            bungee/build/libs/BanManagerBungeeCord.jar
            velocity/build/libs/BanManagerVelocity.jar
            sponge/build/libs/BanManagerSponge.jar
            sponge-api7/build/libs/BanManagerSponge7.jar
            fabric/versions/1.20.1/build/libs/BanManagerFabric-mc1.20.1.jar
            fabric/versions/1.21.1/build/libs/BanManagerFabric-mc1.21.1.jar
            fabric/versions/1.21.4/build/libs/BanManagerFabric-mc1.21.4.jar
