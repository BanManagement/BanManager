name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up JDK 17 for Fabric 1.20.x builds (Gradle toolchain will use this)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: "temurin"

      # Set up JDK 21 as the primary JDK
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - uses: actions/cache@v4
        with:
          path: |
            .gradle/loom-cache
          key: ${{ runner.os }}-loom-${{ hashFiles('**/libs.versions.*', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-loom-

      - name: Build with Gradle
        run: ./gradlew build --build-cache

      # Build all Fabric versions
      - name: Build all Fabric versions
        run: ./gradlew :fabric:1.20.1:remapJar :fabric:1.21.1:remapJar :fabric:1.21.4:remapJar --build-cache

      # Build both Sponge modules (legacy API 7 and modern API 11+)
      - name: Build Sponge modules
        run: ./gradlew :BanManagerSponge:shadowJar :BanManagerSponge7:shadowJar --build-cache

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: ".github/changelog-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: "v${{ steps.version.outputs.VERSION }}"
          body: |
            ${{ steps.changelog.outputs.changelog }}

            ---

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | Bukkit/Spigot/Paper | `BanManagerBukkit.jar` |
            | BungeeCord | `BanManagerBungeeCord.jar` |
            | Velocity | `BanManagerVelocity.jar` |
            | Sponge API 8+ | `BanManagerSponge.jar` |
            | Sponge API 7 | `BanManagerSponge7.jar` |
            | Fabric 1.20.1 | `BanManagerFabric-mc1.20.1.jar` |
            | Fabric 1.21.1 | `BanManagerFabric-mc1.21.1.jar` |
            | Fabric 1.21.4 | `BanManagerFabric-mc1.21.4.jar` |
          files: |
            bukkit/build/libs/BanManagerBukkit.jar
            bungee/build/libs/BanManagerBungeeCord.jar
            velocity/build/libs/BanManagerVelocity.jar
            sponge/build/libs/BanManagerSponge.jar
            sponge-api7/build/libs/BanManagerSponge7.jar
            fabric/build/libs/BanManagerFabric-mc1.20.1.jar
            fabric/build/libs/BanManagerFabric-mc1.21.1.jar
            fabric/build/libs/BanManagerFabric-mc1.21.4.jar
