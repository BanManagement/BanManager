# Parameterized Sponge E2E testing
# Environment variables:
#   MC_VERSION: Minecraft version (default: 1.20.6)
#   JAVA_IMAGE: Java image tag (default: java21)
#   SPONGEVERSION: SpongeVanilla version (default: 1.20.6-11.0.0)

name: bm-sponge

services:
  webhook-sink:
    image: node:22-alpine
    working_dir: /app
    command: ["node", "server.js"]
    volumes:
      - ../webhook-sink:/app:ro
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - banmanager

  mariadb:
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: banmanager
      MYSQL_USER: banmanager
      MYSQL_PASSWORD: banmanager
    healthcheck:
      test: ["CMD", "mariadb", "-uroot", "-proot", "-e", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - banmanager

  sponge:
    image: itzg/minecraft-server:${JAVA_IMAGE:-java21}
    environment:
      EULA: "TRUE"
      TYPE: "CUSTOM"
      CUSTOM_SERVER: "https://repo.spongepowered.org/repository/maven-releases/org/spongepowered/spongevanilla/${SPONGEVERSION:-1.20.6-11.0.0}/spongevanilla-${SPONGEVERSION:-1.20.6-11.0.0}-universal.jar"
      ONLINE_MODE: "false"
      # Skip re-downloading server JAR just to verify hash (speeds up cached runs)
      SKIP_SERVER_JAR_HASH_CHECK: "true"
      ENABLE_RCON: "true"
      RCON_PASSWORD: "testing"
      RCON_PORT: 25575
      MEMORY: "2G"
      SPAWN_PROTECTION: 0
      VIEW_DISTANCE: 4
      SIMULATION_DISTANCE: 4
      MAX_WORLD_SIZE: 100
      LEVEL_TYPE: "flat"
      GENERATE_STRUCTURES: "false"
      COPY_MODS_SRC: "/mods-src"
      COPY_MODS_DEST: "/data/mods"
      COPY_CONFIG_SRC: "/config-src"
      COPY_CONFIG_DEST: "/data/config"
      SYNC_SKIP_NEWER_IN_DESTINATION: "false"
    volumes:
      - ../../../sponge/build/libs/BanManagerSponge.jar:/mods-src/BanManager.jar:ro
      - ./configs/banmanager:/config-src/banmanager:ro
      - ./configs/sponge:/config-src/sponge:ro
      - sponge-data-${MC_VERSION:-1.20.6}:/data
    depends_on:
      webhook-sink:
        condition: service_healthy
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rcon-cli", "--password", "testing", "list"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 180s
    networks:
      - banmanager

  tests:
    image: ${E2E_TEST_IMAGE:-ghcr.io/banmanagement/banmanager-e2e-tests:main}
    build:
      context: ../..
      dockerfile: Dockerfile.tests
    depends_on:
      sponge:
        condition: service_healthy
      webhook-sink:
        condition: service_healthy
    environment:
      SERVER_HOST: sponge
      SERVER_PORT: 25565
      RCON_HOST: sponge
      RCON_PORT: 25575
      RCON_PASSWORD: testing
      MC_VERSION: "${MC_VERSION:-1.20.6}"
      WEBHOOK_SINK_URL: "http://webhook-sink:8080"
    volumes:
      # Cache Jest/ts-jest transformations between runs
      - jest-cache:/tmp/jest_cache
    networks:
      - banmanager

networks:
  banmanager:
    driver: bridge

volumes:
  sponge-data-1.20.6:
  sponge-data-1.21.1:
  sponge-data-1.21.3:
  jest-cache:
